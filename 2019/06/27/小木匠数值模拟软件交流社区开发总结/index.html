<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="项目,">










<meta name="description" content="小木匠项目简介小木匠是一个数值分析科研人员的专属学术交流平台，包括头条，问答，活动，交友，吐槽和招聘六大频道。">
<meta name="keywords" content="项目">
<meta property="og:type" content="article">
<meta property="og:title" content="小木匠数值模拟软件交流社区开发总结">
<meta property="og:url" content="http://yoursite.com/2019/06/27/小木匠数值模拟软件交流社区开发总结/index.html">
<meta property="og:site_name" content="椰子皮&#39;s Blog">
<meta property="og:description" content="小木匠项目简介小木匠是一个数值分析科研人员的专属学术交流平台，包括头条，问答，活动，交友，吐槽和招聘六大频道。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://picture.tjtulong.top/%E9%A6%96%E9%A1%B5.jpg">
<meta property="og:image" content="http://picture.tjtulong.top/%E5%B0%8F%E6%9C%A8%E5%8C%A0%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="http://picture.tjtulong.top/%E6%A8%A1%E5%9D%97.png">
<meta property="og:image" content="http://picture.tjtulong.top/snowflake.jpg">
<meta property="og:image" content="http://picture.tjtulong.top/Rabbit.png">
<meta property="og:updated_time" content="2019-08-31T15:31:30.595Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小木匠数值模拟软件交流社区开发总结">
<meta name="twitter:description" content="小木匠项目简介小木匠是一个数值分析科研人员的专属学术交流平台，包括头条，问答，活动，交友，吐槽和招聘六大频道。">
<meta name="twitter:image" content="http://picture.tjtulong.top/%E9%A6%96%E9%A1%B5.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/06/27/小木匠数值模拟软件交流社区开发总结/">





  <title>小木匠数值模拟软件交流社区开发总结 | 椰子皮's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">椰子皮's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/27/小木匠数值模拟软件交流社区开发总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Tulong Xiao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://picture.tjtulong.top/QQ%E5%9B%BE%E7%89%8720190515225418.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="椰子皮's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">小木匠数值模拟软件交流社区开发总结</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-27T23:41:09+08:00">
                2019-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/项目/" itemprop="url" rel="index">
                    <span itemprop="name">项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  15
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="小木匠项目简介"><a href="#小木匠项目简介" class="headerlink" title="小木匠项目简介"></a>小木匠项目简介</h1><p><strong>小木匠</strong>是一个数值分析科研人员的专属学术交流平台，包括<strong>头条，问答，活动，交友，吐槽和招聘</strong>六大频道。</p>
<p><img src="http://picture.tjtulong.top/%E9%A6%96%E9%A1%B5.jpg" alt></p>
<a id="more"></a>
<h1 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h1><h2 id="系统构架"><a href="#系统构架" class="headerlink" title="系统构架"></a>系统构架</h2><p>项目采用<strong>前后端分离</strong>的系统架构。</p>
<p><strong>后端架构为：</strong></p>
<p>SpringBoot+SpringCloud+SpringMVC+SpringData（Spring全家桶）</p>
<p><strong>前端构架为：</strong></p>
<p>NUXT+ElementUI+Vue+Node.js(以Node.js为核心的Vue.js前端技术生态架构)</p>
<p><img src="http://picture.tjtulong.top/%E5%B0%8F%E6%9C%A8%E5%8C%A0%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.png" alt></p>
<h2 id="前后端分离"><a href="#前后端分离" class="headerlink" title="前后端分离"></a>前后端分离</h2><p>前后端分离已成为互联网项目开发的业界标准使用方式，通过nginx（Web服务器）+tomcat（应用服务器）的方式（也可以中间加一个Node.js）有效的进行解耦。<strong>核心思想是前端html页面通过ajax调用后端的restuful api接口并使用json数据进行交互。</strong></p>
<p>利用Swagger编写统一的API文档，前端用EasyMock模拟数据生成，后端用Postman模拟前端请求，使前后端分别进行开发，降低了耦合。</p>
<p>采用RESTful架构，即表现层状态转化，GET、POST、PUT、DELETE。</p>
<h2 id="模块划分"><a href="#模块划分" class="headerlink" title="模块划分"></a>模块划分</h2><p>为便于扩展，将后端划分为多个微服务模块分别开发：</p>
<p><img src="http://picture.tjtulong.top/%E6%A8%A1%E5%9D%97.png" alt></p>
<h1 id="技术应用"><a href="#技术应用" class="headerlink" title="技术应用"></a>技术应用</h1><h2 id="Docker容器"><a href="#Docker容器" class="headerlink" title="Docker容器"></a>Docker容器</h2><p>Docker设计的目的就是要加强开发人员写代码的开发环境与应用程序要部署的生产环境一致性，保证可移植性，且安装运行快速方便。将MySQL、Redis、MongoDB、ElasticSearch均部署到Docker容器中。</p>
<p>下载镜像：</p>
<p><code>docker pull centos/mysql-57-centos7</code></p>
<p>创建容器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MYSQL_ROOT_PASSWORD=123456 centos/mysql-57-centos7 docker run -di --name=tensquare_mysql -p 3306:3306 -e</span><br></pre></td></tr></table></figure>
<h2 id="分布式ID生成器"><a href="#分布式ID生成器" class="headerlink" title="分布式ID生成器"></a>分布式ID生成器</h2><p>当数据库数据量较大时，常常需要对MySQL进行分片处理（一致性哈希查询），因此不能使用数据库本身的自增功能开产生主键，需要由算法生成唯一的ID，采用开源的Twitter的<strong>snowflake（雪花）算法</strong>。</p>
<p><img src="http://picture.tjtulong.top/snowflake.jpg" alt></p>
<p>默认情况下41bit的时间戳可以支持该算法使用到2082年，10bit的工作机器id可以支持1024台机器，序列号支持1毫秒产生4096个自增序列id . SnowFlake的优点是，整体上按照时间自增排序，而对比UUID是乱序的，会使数据库性能下降。</p>
<h2 id="MySQL优化"><a href="#MySQL优化" class="headerlink" title="MySQL优化"></a>MySQL优化</h2><p><strong>建立索引</strong></p>
<p>查询推荐职位列表时，查询按照时间降序的前8条记录：</p>
<p><code>public List&lt;Recruit&gt; findTop4ByStateOrderByCreatetimeDesc(String state);</code></p>
<p>为提高查询效率，给职位表的createtime字段<strong>建立索引</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`tb_recruit`</span> <span class="keyword">ADD</span> <span class="keyword">INDEX</span> index_name (<span class="string">`createtime`</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Redis缓存"><a href="#Redis缓存" class="headerlink" title="Redis缓存"></a>Redis缓存</h2><p>由于文章在主页中显示，查询频率很高，为提高查询性能，利用Redis缓存技术解决。</p>
<p>在查询文章时，先尝试从缓存中取数据，如果缓存中没有数据，再到数据库中查找放入缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Article <span class="title">findById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//先从缓存中查询当前对象</span></span><br><span class="line">    Article article = (Article) redisTemplate.opsForValue().get(<span class="string">"article_"</span> + id);</span><br><span class="line">    <span class="comment">//如果没有取到，从数据库中查询</span></span><br><span class="line">    <span class="keyword">if</span> (article == <span class="keyword">null</span>) &#123;</span><br><span class="line">        article = articleDao.findById(id).get();</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">"article_"</span> + id, article);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> article;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在删除和修改时，先在缓存中删除数据，再在数据库中修改</p>
<h2 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h2><p>问答模块存在以下的特点：</p>
<ul>
<li>数据量大</li>
<li>写入操作频发</li>
<li>价值较低</li>
<li>数据之间有关联</li>
</ul>
<p>对于这样的数据，可以采用MongoDB来实现数据的存储，MongoDB是一个跨平台的，面向文档的数据库，是当前NoSQL数据库产品中最热门的一种，它是非关系型数据库中功能最丰富，最像关系型数据库的产品。</p>
<p>利用SpringDataMongoDB可以完成持久层业务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpitDao</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Spit</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;Spit&gt; <span class="title">findByParentid</span><span class="params">(String parentid, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此外，<strong>文章评论</strong>部分也用到了MongoDB。</p>
<h2 id="分布式搜索引擎ElasticSearch"><a href="#分布式搜索引擎ElasticSearch" class="headerlink" title="分布式搜索引擎ElasticSearch"></a>分布式搜索引擎ElasticSearch</h2><p>ElasticSearch是一个基于Lucene的搜索服务器，提供了全文搜索引擎，基于Restful web接口。</p>
<p><strong>Elasticsearch与MySQL数据库逻辑结构概念对比</strong></p>
<table>
<thead>
<tr>
<th>Elasticsearch</th>
<th>关系型数据库MySQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>索引（index）</td>
<td>数据库（database）</td>
</tr>
<tr>
<td>类型（type）</td>
<td>表（table）</td>
</tr>
<tr>
<td>文档（document）</td>
<td>行（row）</td>
</tr>
</tbody>
</table>
<p>基本查询匹配url：</p>
<p><code>http://192.168.184.134:9200/articleindex/article/_search?q=title:有限元</code></p>
<p>默认的中文分词是将每个字看成一个词，采用<strong>IK分词器</strong>可以合理地将汉语进行分词。</p>
<p>利用spring‐data‐elasticsearch依赖，可以像操作数据库一样实现对Elasticsearch的增删改查。</p>
<p><strong>实体类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document</span>(indexName = <span class="string">"xiaomujiang_article"</span>, type = <span class="string">"article"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;<span class="comment">//ID</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    是否索引：表示是否能够被搜索</span></span><br><span class="line"><span class="comment">    是否分词：表示搜索的时候是整体匹配还是单词匹配</span></span><br><span class="line"><span class="comment">    是否存储：表示是否在页面显示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Field</span>(index = <span class="keyword">true</span>, analyzer = <span class="string">"ik_max_word"</span>, searchAnalyzer = <span class="string">"ik_max_word"</span>)</span><br><span class="line">    <span class="keyword">private</span> String title;<span class="comment">//标题</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field</span>(index = <span class="keyword">true</span>, analyzer = <span class="string">"ik_max_word"</span>, searchAnalyzer = <span class="string">"ik_max_word"</span>)</span><br><span class="line">    <span class="keyword">private</span> String content;<span class="comment">//文章正文</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String state;<span class="comment">//审核状态</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//getter and setter ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>持久层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArticleDao</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Article</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 检索</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;Article&gt; <span class="title">findByTitleOrContentLike</span><span class="params">(String title, String content, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过Logstash日志搜集处理框架进行ElasticSearch和MySQL之间的同步</p>
<h2 id="消息中间件RabbitMQ"><a href="#消息中间件RabbitMQ" class="headerlink" title="消息中间件RabbitMQ"></a>消息中间件RabbitMQ</h2><p>消息队列在实际应用中常用的使用场景：<strong>异步处理，应用解耦，流量削锋和消息通讯</strong>。</p>
<p>RabbitMQ的构架：</p>
<p><img src="http://picture.tjtulong.top/Rabbit.png" alt></p>
<p>生产者将消息发送到<strong>Exchange</strong>（交换器），由Exchange将消息路由到一个或多个<strong>Queue</strong>中（或者丢弃）。Exchange并不存储消息。RabbitMQ中的Exchange有direct、fanout、topic、headers四种类型，每种类型对应不同的路由规则。</p>
<ol>
<li>直接模式：将消息发给唯一一个节点时使用</li>
<li>分列模式：将消息一次发给多个队列时使用</li>
<li>主题模式：任何发送到Topic Exchange的消息都会被转发到所有关心RouteKey中指定话题的Queue上</li>
</ol>
<p><strong>生产者：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSend</span><span class="params">()</span></span>&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"itcast"</span>,<span class="string">"我要红包"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>消费者：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues=<span class="string">"itcast"</span> )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer1</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"itcast接收到消息："</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="BCrypt密码加密"><a href="#BCrypt密码加密" class="headerlink" title="BCrypt密码加密"></a>BCrypt密码加密</h2><p>Spring Security提供了BCryptPasswordEncoder类，实现Spring的PasswordEncoder接口使用BCrypt强<br>哈希方法来加密密码。</p>
<p>密码加密：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">BCryptPasswordEncoder encoder;</span><br><span class="line"></span><br><span class="line">String newpassword = encoder.encode(user.getPassword());</span><br></pre></td></tr></table></figure>
<p>密码验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">encoder.matches(password,user.getPassword())；</span><br></pre></td></tr></table></figure>
<h2 id="Token身份认证"><a href="#Token身份认证" class="headerlink" title="Token身份认证"></a>Token身份认证</h2><p>基于Token身份认证的流程为：</p>
<ol>
<li><p>客户端使用用户名跟密码请求登录</p>
</li>
<li><p>服务端收到请求，去验证用户名与密码</p>
</li>
<li>验证成功后，服务端会签发一个 Token，再把这个 Token 发送给客户端</li>
<li>客户端收到 Token 以后可以把它存储起来，比如放在 Cookie 里</li>
<li>客户端每次向服务端请求资源的时候需要带着服务端签发的 Token</li>
<li>服务端收到请求，然后去验证客户端请求里面带着的 Token，如果验证成功，就向客户端返回请求的数据</li>
</ol>
<p>本项目中采用的是<strong>JSON Web Token（JWT）</strong>，一个JWT实际上就是一个字符串，它由三部分组成，<strong>头部、载荷与签名</strong>，形式如下：</p>
<p><code>eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1MjM0MTM0NTh9.gq0J‐cOM_qCNqU_s‐d_IrRytaNenesPmqAIhQpYXHZk</code></p>
<p><strong>生成JWT：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">createJWT</span><span class="params">(String id, String subject, String roles)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> nowMillis = System.currentTimeMillis();</span><br><span class="line">    Date now = <span class="keyword">new</span> Date(nowMillis);</span><br><span class="line">    JwtBuilder builder = Jwts.builder().setId(id)</span><br><span class="line">            .setSubject(subject)</span><br><span class="line">            .setIssuedAt(now)</span><br><span class="line">            .signWith(SignatureAlgorithm.HS256, key).claim(<span class="string">"roles"</span>, roles);</span><br><span class="line">    <span class="keyword">if</span> (ttl &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        builder.setExpiration( <span class="keyword">new</span> Date( nowMillis + ttl));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.compact();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>解析JWT：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Claims <span class="title">parseJWT</span><span class="params">(String jwtStr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  Jwts.parser()</span><br><span class="line">            .setSigningKey(key)</span><br><span class="line">            .parseClaimsJws(jwtStr)</span><br><span class="line">            .getBody();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h2><p>Spring Cloud是<strong>一系列框架的有序集合</strong>。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、熔断器、数据监控等，都可以用Spring Boot的开发风格做到一键启动和部署，包括：</p>
<ul>
<li>服务发现——Netflix Eureka</li>
<li>服务调用——Netflix Feign</li>
<li>熔断器——Netflix Hystrix</li>
<li>服务网关——Netflix Zuul</li>
<li>分布式配置——Spring Cloud Config</li>
<li>消息总线 —— Spring Cloud Bus</li>
</ul>
<h3 id="服务发现组件-Eureka"><a href="#服务发现组件-Eureka" class="headerlink" title="服务发现组件 Eureka"></a>服务发现组件 Eureka</h3><p>Eureka Server提供服务注册服务，各个节点启动后，会在Eureka Server中进行注册，这样EurekaServer中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观的看到。</p>
<h3 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h3><p>Feign实现服务间的调用，例如在问答微服务调用基础微服务的方法（根据ID查询标签）。</p>
<p>step1: 在问答模块的启动类上添加注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br></pre></td></tr></table></figure>
<p>step2：创建基础微服务方法的接口，可自动实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"tensquare‐base"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LabelClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/label/&#123;id&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">findById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="微服务网关Zuul"><a href="#微服务网关Zuul" class="headerlink" title="微服务网关Zuul"></a>微服务网关Zuul</h3><p>微服务网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过微服务网关。</p>
<p>通过Zuul的过滤器可以截取token并验证。</p>
<h1 id="业务难点"><a href="#业务难点" class="headerlink" title="业务难点"></a>业务难点</h1><h2 id="点赞"><a href="#点赞" class="headerlink" title="点赞"></a>点赞</h2><p><strong>对于文章的点赞</strong></p>
<p>文章的点赞并不频繁，且实时性没有特别重要，在点赞处理上，直接在MySQL中进行+1修改即可，对Redis缓存中的文章加上1天的过期时间，在过期后再一次加载时就可以得到最新的点赞数了。</p>
<p><code>redisTemplate.opsForValue().set(&quot;article_&quot; + id, article,1,TimeUnit.DAYS);</code></p>
<p><strong>对于问答的点赞</strong></p>
<p>直接利用MongoTemplete类来将问答对应文档的点赞属性加1即可(<strong>inc命令</strong>)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateThumbup</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//方式一：效率低</span></span><br><span class="line">    <span class="comment">/*Spit spit = spitDao.findById(id).get();</span></span><br><span class="line"><span class="comment">    spit.setThumbup(spit.getThumbup() + 1);</span></span><br><span class="line"><span class="comment">    spitDao.save(spit);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//方式二:原生命令</span></span><br><span class="line">    Query query = <span class="keyword">new</span> Query();</span><br><span class="line">    query.addCriteria(Criteria.where(<span class="string">"_id"</span>).is(id));</span><br><span class="line">    Update update = <span class="keyword">new</span> Update();</span><br><span class="line">    update.inc(<span class="string">"thumbup"</span>, <span class="number">1</span>);</span><br><span class="line">    mongoTemplate.updateFirst(query, update, <span class="string">"spit"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>控制点赞不能重复</strong></p>
<p>通过Redis控制点赞不能重复，当一个用户已经对某个回答点赞后，在Redis中加入一条记录，key为：</p>
<p><code>thumbup_+userid+qaid</code></p>
<p>当查询到Redis中有这个key时，则返回重复点赞提示。</p>
<h2 id="用户注册"><a href="#用户注册" class="headerlink" title="用户注册"></a>用户注册</h2><p>用户注册时要通过手机验证码进行验证，解决方案为：</p>
<p>在用户微服务编写API ,生成手机验证码，存入Redis并发送到RabbitMQ。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAms</span><span class="params">(String mobile)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//生成随机数</span></span><br><span class="line">    String checkcode = RandomStringUtils.randomNumeric(<span class="number">6</span>);</span><br><span class="line">    <span class="comment">//向缓存中放一份</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">"checkcode_"</span> + mobile, checkcode, <span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">"mobile"</span>, mobile);</span><br><span class="line">    map.put(<span class="string">"checkcode"</span>, checkcode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//给用户发一份</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">"sms"</span>,map);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开发<strong>短信发送微服务</strong>，从rabbitMQ中提取消息，调用<strong>阿里大于短信接口</strong>实现短信发送。</p>
<h2 id="交友业务"><a href="#交友业务" class="headerlink" title="交友业务"></a>交友业务</h2><ul>
<li><p>当用户登陆后在推荐好友列表中点击“心”，表示关注此人 ，在数据库tb_friend表中插入一条数据，islike 为0；当你已经关注对方后又点击了关注，则会提示重复关注。</p>
</li>
<li><p>当你点击了关注过的人，也关注了你 , 表示互粉成功，在tb_friend表中修改一条数据，islike为1 ，并且将你喜欢她的数据islike也修改为1；</p>
</li>
<li>当你点击了拉黑某人（点击了叉），向tb_nofriend表添加记录；</li>
<li>当两个人互粉后，其中一人拉黑对方了，删除好友表中的记录 ，向非好友表中添加记录。</li>
</ul>
<p>因此在业务层中实现的方法包括：addFriend、addNoFriend和deleteFriend三个</p>
<p>同时需要利用SpringCloud中的Feign实现交友业务与用户微服务的调用，当A关注B后，A的关注数加1，B的关注数减1，这个操作要在tb_user表中修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"xiaomujiang-user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;userid&#125;/&#123;friendid&#125;/&#123;x&#125;"</span>, method = RequestMethod.PUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatefanscountandfollowcount</span><span class="params">(@PathVariable(<span class="string">"userid"</span>)</span> String userid,</span></span><br><span class="line"><span class="function">                                              @<span class="title">PathVariable</span><span class="params">(<span class="string">"friendid"</span>)</span> String friendid,</span></span><br><span class="line"><span class="function">                                              @<span class="title">PathVariable</span><span class="params">(<span class="string">"x"</span>)</span> <span class="keyword">int</span> x)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="积分排名"><a href="#积分排名" class="headerlink" title="积分排名"></a>积分排名</h2><p>为鼓励用户发表文章和回答，用户每发表一篇文章或回答问题时都会得到相应的积分，在首页上会有每周的积分排名。本项目中利用Redis中的SortedSet实现，SortedSet通过score权重去排名，可以得到前十的排名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrevrange hotmessage 0 10</span><br></pre></td></tr></table></figure>
<p>由于每周更新，对key加上一周的过期时间。</p>
<h1 id="开发要点"><a href="#开发要点" class="headerlink" title="开发要点"></a>开发要点</h1><h2 id="公共异常处理"><a href="#公共异常处理" class="headerlink" title="公共异常处理"></a>公共异常处理</h2><p>为了使代码更容易维护，创建一个类集中处理异常:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = Exception.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">exception</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, StatusCode.ERROR, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="跨域处理"><a href="#跨域处理" class="headerlink" title="跨域处理"></a>跨域处理</h2><p>浏览器从一个域名的网页去请求另一个域名的资源时，域名、端口、协议任一不同，都是跨域 。本项目采用前后端分离开发的，也是前后端分离部署的，必然会存在跨域问题。 SpringBoot对于跨域请求处理只需要在controller类上添加注解<code>@CrossOrigin</code>即可。这个注解其实是<strong>CORS</strong>(Cross-Origin Resource Sharing, 跨源资源共享)的实现。</p>
<p><em>CSRF（Cross-site request forgery），中文名称：跨站请求伪造。CSRF 攻击的原理大致描述如下：有两个网站，其中A网站是真实受信任的网站，而B网站是危险网站。在用户登陆了受信任的A网站是，本地会存储A网站相关的Cookie，并且浏览器也维护这一个Session会话。这时，如果用户在没有登出A网站的情况下访问危险网站B，那么危险网站B就可以模拟发出一个对A网站的请求（跨域请求）对A网站进行操作，而在A网站的角度来看是并不知道请求是由B网站发出来的（Session和Cookie均为A网站的），这时便成功发动一次CSRF 攻击。</em></p>
<h2 id="带分页的条件查询"><a href="#带分页的条件查询" class="headerlink" title="带分页的条件查询"></a>带分页的条件查询</h2><p>关键：两个参数：Specification+PageRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Label&gt; <span class="title">pageQuery</span><span class="params">(Label label, <span class="keyword">int</span> page, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    Pageable pageable = PageRequest.of(page-<span class="number">1</span>,size);</span><br><span class="line">    <span class="keyword">return</span> labelDao.findAll(<span class="keyword">new</span> Specification&lt;Label&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Predicate <span class="title">toPredicate</span><span class="params">(Root&lt;Label&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder criteriaBuilder)</span> </span>&#123;</span><br><span class="line">            List&lt;Predicate&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (label.getLabelname() != <span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(label.getLabelname())) &#123;</span><br><span class="line">                Predicate predicate = criteriaBuilder.like(root.get(<span class="string">"labelname"</span>).as(String.class), <span class="string">"%"</span> + label.getLabelname() + <span class="string">"%"</span>);</span><br><span class="line">                list.add(predicate);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(label.getState()!=<span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(label.getState()))&#123;</span><br><span class="line">                list.add(criteriaBuilder.equal(root.get(<span class="string">"state"</span>).as(String.class), label.getState()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Predicate[] parr = <span class="keyword">new</span> Predicate[list.size()];</span><br><span class="line">            list.toArray(parr);</span><br><span class="line">            <span class="keyword">return</span> criteriaBuilder.and(parr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,pageable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h2><p>在问答模块中生成最新回答列表时，需要关联查询，选出回复时间最近的问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProblemDao</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Problem</span>, <span class="title">String</span>&gt;, <span class="title">JpaSpecificationExecutor</span>&lt;<span class="title">Problem</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Query</span>(value = <span class="string">"select * from tb_problem,tb_pl where id = problemid and labelid = ? order by replytime desc"</span>, nativeQuery = <span class="keyword">true</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;Problem&gt; <span class="title">newList</span><span class="params">(String labelid, Pageable pageable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query</span>(value = <span class="string">"select * from tb_problem,tb_pl where id = problemid and labelid = ? order by reply desc"</span>, nativeQuery = <span class="keyword">true</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;Problem&gt; <span class="title">hotList</span><span class="params">(String labelid, Pageable pageable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query</span>(value = <span class="string">"select * from tb_problem,tb_pl where id = problemid and labelid = ? and reply = 0"</span>, nativeQuery = <span class="keyword">true</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;Problem&gt; <span class="title">waitList</span><span class="params">(String labelid, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SpringCache"><a href="#SpringCache" class="headerlink" title="SpringCache"></a>SpringCache</h2><p>Spring Cache的核心就是对某个方法进行缓存，其实质就是缓存该方法的返回结果，并把方法参数和结果用键值对的方式存放到缓存中，当再次调用该方法使用相应的参数时，就会直接从缓存里面取出指定的结果进行返回。</p>
<p>@Cacheable——-使用这个注解的方法在执行后会缓存其返回结果。<br>@CacheEvict——–使用这个注解的方法在其执行前或执行后移除Spring Cache中的某些元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(value = <span class="string">"gathering"</span>, key = <span class="string">"#id"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Gathering <span class="title">findById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gatheringDao.findById(id).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="拦截器授权Token"><a href="#拦截器授权Token" class="headerlink" title="拦截器授权Token"></a>拦截器授权Token</h2><p>在Controller处理请求之前，先通过拦截器Interceptor获取并解析Token，放入Request域中再进行后续处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//System.out.println("经过拦截器");</span></span><br><span class="line">        <span class="comment">//拦截器仅对请求头进行token抽取</span></span><br><span class="line">        <span class="keyword">final</span> String authHeader = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        <span class="keyword">if</span> (authHeader != <span class="keyword">null</span> &amp;&amp; authHeader.startsWith(<span class="string">"Bearer "</span>)) &#123;</span><br><span class="line">            <span class="keyword">final</span> String token = authHeader.substring(<span class="number">7</span>); <span class="comment">// The part after "Bearer "</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Claims claims = jwtUtil.parseJWT(token);</span><br><span class="line">                <span class="keyword">if</span> (claims != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"admin"</span>.equals(claims.get(<span class="string">"roles"</span>))) &#123;<span class="comment">//如果是管理员</span></span><br><span class="line">                        request.setAttribute(<span class="string">"admin_claims"</span>, claims);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"user"</span>.equals(claims.get(<span class="string">"roles"</span>))) &#123;<span class="comment">//如果是用户</span></span><br><span class="line">                        request.setAttribute(<span class="string">"user_claims"</span>, claims);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"令牌不正确！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/项目/" rel="tag"># 项目</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/16/SpringBoot与数据访问/" rel="next" title="SpringBoot与数据访问">
                <i class="fa fa-chevron-left"></i> SpringBoot与数据访问
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/30/商城仿写开发总结/" rel="prev" title="商城仿写开发总结">
                商城仿写开发总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://picture.tjtulong.top/QQ%E5%9B%BE%E7%89%8720190515225418.jpg" alt="Tulong Xiao">
            
              <p class="site-author-name" itemprop="name">Tulong Xiao</p>
              <p class="site-description motion-element" itemprop="description">Almost Famous</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/TJtulong" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:TJtulong@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/2610493505/home" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/TJtulong" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-book"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.tongji.edu.cn/" title="同济大学" target="_blank">同济大学</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#小木匠项目简介"><span class="nav-number">1.</span> <span class="nav-text">小木匠项目简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#系统设计"><span class="nav-number">2.</span> <span class="nav-text">系统设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#系统构架"><span class="nav-number">2.1.</span> <span class="nav-text">系统构架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前后端分离"><span class="nav-number">2.2.</span> <span class="nav-text">前后端分离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模块划分"><span class="nav-number">2.3.</span> <span class="nav-text">模块划分</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#技术应用"><span class="nav-number">3.</span> <span class="nav-text">技术应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker容器"><span class="nav-number">3.1.</span> <span class="nav-text">Docker容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式ID生成器"><span class="nav-number">3.2.</span> <span class="nav-text">分布式ID生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL优化"><span class="nav-number">3.3.</span> <span class="nav-text">MySQL优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis缓存"><span class="nav-number">3.4.</span> <span class="nav-text">Redis缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MongoDB"><span class="nav-number">3.5.</span> <span class="nav-text">MongoDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式搜索引擎ElasticSearch"><span class="nav-number">3.6.</span> <span class="nav-text">分布式搜索引擎ElasticSearch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息中间件RabbitMQ"><span class="nav-number">3.7.</span> <span class="nav-text">消息中间件RabbitMQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BCrypt密码加密"><span class="nav-number">3.8.</span> <span class="nav-text">BCrypt密码加密</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Token身份认证"><span class="nav-number">3.9.</span> <span class="nav-text">Token身份认证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringCloud"><span class="nav-number">3.10.</span> <span class="nav-text">SpringCloud</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务发现组件-Eureka"><span class="nav-number">3.10.1.</span> <span class="nav-text">服务发现组件 Eureka</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign"><span class="nav-number">3.10.2.</span> <span class="nav-text">Feign</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#微服务网关Zuul"><span class="nav-number">3.10.3.</span> <span class="nav-text">微服务网关Zuul</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#业务难点"><span class="nav-number">4.</span> <span class="nav-text">业务难点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#点赞"><span class="nav-number">4.1.</span> <span class="nav-text">点赞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用户注册"><span class="nav-number">4.2.</span> <span class="nav-text">用户注册</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#交友业务"><span class="nav-number">4.3.</span> <span class="nav-text">交友业务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#积分排名"><span class="nav-number">4.4.</span> <span class="nav-text">积分排名</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开发要点"><span class="nav-number">5.</span> <span class="nav-text">开发要点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#公共异常处理"><span class="nav-number">5.1.</span> <span class="nav-text">公共异常处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#跨域处理"><span class="nav-number">5.2.</span> <span class="nav-text">跨域处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#带分页的条件查询"><span class="nav-number">5.3.</span> <span class="nav-text">带分页的条件查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关联查询"><span class="nav-number">5.4.</span> <span class="nav-text">关联查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringCache"><span class="nav-number">5.5.</span> <span class="nav-text">SpringCache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#拦截器授权Token"><span class="nav-number">5.6.</span> <span class="nav-text">拦截器授权Token</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tulong Xiao</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
