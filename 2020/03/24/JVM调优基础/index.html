<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="JVM,">










<meta name="description" content="JVM参数调整标配参数各版本之间很稳定，没有变化。 -version -help java -showversion X参数HotSpot VM 默认为混合模式 -Xint：解释执行 -Xcomp：第一次使用就编译成本地代码 -Xmixed：混合模式">
<meta name="keywords" content="JVM">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM调优基础">
<meta property="og:url" content="http://yoursite.com/2020/03/24/JVM调优基础/index.html">
<meta property="og:site_name" content="椰子皮&#39;s Blog">
<meta property="og:description" content="JVM参数调整标配参数各版本之间很稳定，没有变化。 -version -help java -showversion X参数HotSpot VM 默认为混合模式 -Xint：解释执行 -Xcomp：第一次使用就编译成本地代码 -Xmixed：混合模式">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://picture.tjtulong.top/JVM%E5%8F%82%E6%95%B0%E5%9B%BE.png">
<meta property="og:image" content="http://picture.tjtulong.top/Java8%E5%8F%82%E6%95%B0.png">
<meta property="og:image" content="http://picture.tjtulong.top/%E8%87%AA%E5%AE%9A%E4%B9%89JVM%E5%A0%86.JPG">
<meta property="og:image" content="http://picture.tjtulong.top/JVM%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0.JPG">
<meta property="og:image" content="http://picture.tjtulong.top/Types-of-Java-Garbage-Collectors3_th_thumb.jpg">
<meta property="og:image" content="http://picture.tjtulong.top/%E4%B8%83%E7%A7%8D%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8.png">
<meta property="og:image" content="http://picture.tjtulong.top/%E4%B8%83%E7%A7%8D%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A82.png">
<meta property="og:image" content="http://picture.tjtulong.top/%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6.JPG">
<meta property="og:image" content="http://picture.tjtulong.top/PerNew.jpeg">
<meta property="og:image" content="http://picture.tjtulong.top/CMS%E6%94%B6%E9%9B%86%E5%99%A8.jpg">
<meta property="og:image" content="http://picture.tjtulong.top/G1%E5%88%86%E5%9D%97.jpg">
<meta property="og:image" content="http://picture.tjtulong.top/G1%E6%94%B6%E9%9B%86%E5%99%A8.jpg">
<meta property="og:image" content="http://picture.tjtulong.top/%E9%80%89%E6%8B%A9%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8.jpg">
<meta property="og:image" content="http://picture.tjtulong.top/youngGCDetail.png">
<meta property="og:image" content="http://picture.tjtulong.top/FullGC%E6%97%A5%E7%A7%9F.jpg">
<meta property="og:updated_time" content="2020-04-15T13:26:49.937Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JVM调优基础">
<meta name="twitter:description" content="JVM参数调整标配参数各版本之间很稳定，没有变化。 -version -help java -showversion X参数HotSpot VM 默认为混合模式 -Xint：解释执行 -Xcomp：第一次使用就编译成本地代码 -Xmixed：混合模式">
<meta name="twitter:image" content="http://picture.tjtulong.top/JVM%E5%8F%82%E6%95%B0%E5%9B%BE.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/03/24/JVM调优基础/">





  <title>JVM调优基础 | 椰子皮's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">椰子皮's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/24/JVM调优基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Tulong Xiao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://picture.tjtulong.top/QQ%E5%9B%BE%E7%89%8720190515225418.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="椰子皮's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">JVM调优基础</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-24T09:48:21+08:00">
                2020-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java基础/" itemprop="url" rel="index">
                    <span itemprop="name">java基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  20
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="JVM参数调整"><a href="#JVM参数调整" class="headerlink" title="JVM参数调整"></a>JVM参数调整</h1><h2 id="标配参数"><a href="#标配参数" class="headerlink" title="标配参数"></a>标配参数</h2><p>各版本之间很稳定，没有变化。</p>
<p><code>-version</code></p>
<p><code>-help</code></p>
<p><code>java -showversion</code></p>
<h2 id="X参数"><a href="#X参数" class="headerlink" title="X参数"></a>X参数</h2><p>HotSpot VM 默认为混合模式</p>
<p><code>-Xint</code>：解释执行</p>
<p><code>-Xcomp</code>：第一次使用就编译成本地代码</p>
<p><code>-Xmixed</code>：混合模式</p>
<a id="more"></a>
<h2 id="XX参数"><a href="#XX参数" class="headerlink" title="XX参数"></a>XX参数</h2><h3 id="Boolean类型"><a href="#Boolean类型" class="headerlink" title="Boolean类型"></a>Boolean类型</h3><p><code>-XX:+或-某个属性值</code>+表示开启 -表示关闭</p>
<p><strong>Case：</strong></p>
<p><strong>是否打印GC收集细节</strong>： <code>-XX:+PrintGCDetails</code> 开启   <code>-XX:-PrintGCDetails</code> 关闭</p>
<p><strong>是否使用串行垃圾回收器</strong>：<code>-XX:-UseSerialGC</code></p>
<p>p.s. 查看一个正在运行的Java程序的某个JVM参数是否开启，具体值为多少？</p>
<p><code>jps -l</code>  可以得到正在运行的Java进程编号</p>
<p><code>jinfo -flag PrintGCDetails 13632</code>  查看是否添加了某参数</p>
<p><code>jinfo -flags 13632</code> 查看修改的所有的参数值</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Non-default VM flags: -XX:CICompilerCount=<span class="number">3</span> -XX:InitialHeapSize=<span class="number">10485760</span> -XX:MaxHeapSize=<span class="number">10485760</span> -XX:MaxNewSize=<span class="number">3145728</span> -XX:Mi</span><br><span class="line">nHeapDeltaBytes=<span class="number">524288</span> -XX:NewSize=<span class="number">3145728</span> -XX:OldSize=<span class="number">7340032</span> -XX:+PrintGCDetails -XX:+UseCompressedClassPointers -XX:+UseComp</span><br><span class="line">ressedOops -XX:+UseFastUnorderedTimeStamps -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC</span><br><span class="line">Command line:  -Xms10m -Xmx10m -XX:+PrintGCDetails -javaagent:C:\Program Files\JetBrains\IntelliJ IDEA <span class="number">2018</span>.<span class="number">2</span>\lib\idea_rt.jar=<span class="number">1</span></span><br><span class="line"><span class="number">2035</span>:C:\Program Files\JetBrains\IntelliJ IDEA <span class="number">2018</span>.<span class="number">2</span>\bin -Dfile.encoding=UTF-<span class="number">8</span></span><br></pre></td></tr></table></figure>
<h3 id="KV设值类型"><a href="#KV设值类型" class="headerlink" title="KV设值类型"></a>KV设值类型</h3><p><code>-XX:属性key=属性值value</code></p>
<p><strong>Case：</strong></p>
<p><code>-XX:MetaspaceSize=128m</code></p>
<p><em>p.s.元空间默认初始值为21m</em></p>
<p><code>-XX:MaxTenuringThreshold=15</code> 设定年龄阈值</p>
<p><code>-Xms</code> 等同于 <code>-XX:InitialHeapSize</code></p>
<p><code>-Xmx</code> 等同于 <code>-XX:MaxHeapSize</code></p>
<p><strong>Java7：</strong></p>
<p><img src="http://picture.tjtulong.top/JVM%E5%8F%82%E6%95%B0%E5%9B%BE.png" width="650" height="高度" alt="图片名称" align="center"></p>
<p><strong>Java8：</strong></p>
<p>Java8以后的元空间并不在虚拟机中而是使用本地物理内存，这样可以加载多少类的元数据就不再由MaxPermSize控制，而是由系统的实际可用空间来控制。</p>
<p><img src="http://picture.tjtulong.top/Java8%E5%8F%82%E6%95%B0.png" width="650" height="高度" alt="图片名称" align="center"></p>
<table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:center">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-Xms</td>
<td style="text-align:center">设置初始分配大小，默认为物理内存的1 / 64</td>
</tr>
<tr>
<td style="text-align:center">-Xmx</td>
<td style="text-align:center">最大分配内存，默认为物理内存的1 / 4</td>
</tr>
<tr>
<td style="text-align:center">-XX:+PrintGCDetails</td>
<td style="text-align:center">输出详细的GC处理日志</td>
</tr>
<tr>
<td style="text-align:center">-Xss</td>
<td style="text-align:center">为JVM启动的每个线程分配的栈内存大小</td>
</tr>
</tbody>
</table>
<p>测试案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JVMDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//返回Java虚拟机试图使用的最大内存量。</span></span><br><span class="line">        <span class="keyword">long</span> maxMemory = Runtime.getRuntime().maxMemory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回Java虚拟机中的内存总量</span></span><br><span class="line">        <span class="keyword">long</span> totalMemory = Runtime.getRuntime().totalMemory();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"MAX_MEMORY = "</span> + maxMemory + <span class="string">"（字节）、"</span> + (maxMemory / (<span class="keyword">double</span>) <span class="number">1024</span> / <span class="number">1024</span>) + <span class="string">"MB"</span>);</span><br><span class="line">        System.out.println(<span class="string">"TOTAL_MEMORY = "</span> + totalMemory + <span class="string">"（字节）、"</span> + (totalMemory / (<span class="keyword">double</span>) <span class="number">1024</span> / <span class="number">1024</span>) + <span class="string">"MB"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//MAX_MEMORY = 1886912512（字节）、1799.5MB 8G的四分之一</span></span><br><span class="line"><span class="comment">//TOTAL_MEMORY = 128974848（字节）、123.0MB</span></span><br></pre></td></tr></table></figure>
<p>在实际工程中，必须<strong>将Xms与Xmx设置为相同</strong>，避免内存忽高忽低导致停顿，避免JVM在运行时向OS申请内存。</p>
<p><strong>设置JVM参数</strong>：<code>-Xms1024m -Xmx1024m -XX:+PrintGCDetails</code></p>
<p>再次执行上述代码：</p>
<p><img src="http://picture.tjtulong.top/%E8%87%AA%E5%AE%9A%E4%B9%89JVM%E5%A0%86.JPG" alt></p>
<h2 id="查看参数"><a href="#查看参数" class="headerlink" title="查看参数"></a>查看参数</h2><p><code>-XX:+PrintFlagsInitial</code> 查看初始默认值（未运行）</p>
<p><img src="http://picture.tjtulong.top/JVM%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0.JPG" alt></p>
<p><code>-XX:+PrintFlagsFinal</code>查看修改后的参数 <code>:=</code>说明是修改过的</p>
<p><code>-XX:+PrintCommandLineFlags</code>  查看使用的垃圾回收器(仅限Windows)</p>
<h2 id="常用基本配置参数"><a href="#常用基本配置参数" class="headerlink" title="常用基本配置参数"></a>常用基本配置参数</h2><p><strong>-Xms</strong></p>
<p>初始大小内存，默认为物理内存1/64，等价于<code>-XX:InitialHeapSize</code></p>
<p><strong>-Xmx</strong></p>
<p>最大分配内存，默认物理内存1/4，等价于<code>-XX:MaxHeapSize</code></p>
<p><strong>-Xss</strong></p>
<p>设置单个线程<strong>栈</strong>的大小，默认542K~1024K ，等价于<code>-XX:ThreadStackSize</code></p>
<p><strong>-Xmn</strong></p>
<p>设值新生代大小，一般用默认值</p>
<p><strong>-XX:MetaspaceSize</strong></p>
<p>设值元空间大小，默认只有21m，可以把元空间配置的大一些（512m）。</p>
<p><strong>-XX:+PrintGCDetails</strong></p>
<p>输出详细GC收集日志信息</p>
<p><strong>-XX:+PrintGCTimeStamps</strong></p>
<p>打印GC时间戳</p>
<p><strong>-XX:+PrintGCCauses</strong></p>
<p>打印GC原因</p>
<p><strong>-XX:SurvivorRatio</strong></p>
<p>设置新生代中Eden和S0/S1空间的比例</p>
<p>默认<code>-XX:SurvivorRatio=8</code>,Eden：S0：S1=8：1：1</p>
<p><strong>-XX:NewRatio</strong></p>
<p>设置年轻代与老年代在堆结构的占比，一般用默认值</p>
<p>默认<code>-XX:NewRatio=2</code>  新生代占1，老年代占2，年轻代占整个堆的1/3</p>
<p><strong>-XX:MaxTenuringThreshold</strong></p>
<p>设置新生代垃圾的最大年龄</p>
<p>默认<code>-XX:MaxTenuringThreshold=15</code></p>
<p>如果设置为0，年轻代对象不经过Survivor区，直接进入年老代。对于年老代比较多的应用，可以提高效率。如果将此值设置为一个较大的值，则年轻代对象回在Survivor区进行多次复制，这样可以增加对对象在年轻代的存活时间，增加在年轻代即被回收的概率</p>
<h1 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h1><h2 id="垃圾回收方式"><a href="#垃圾回收方式" class="headerlink" title="垃圾回收方式"></a>垃圾回收方式</h2><p><strong>四种主要垃圾回收方式：</strong></p>
<p><img src="http://picture.tjtulong.top/Types-of-Java-Garbage-Collectors3_th_thumb.jpg" width="600" height="高度" alt="图片名称" align="center"></p>
<ol>
<li><p><strong>Serial 串行回收</strong></p>
<p>为单线程换进该设计且只是用过一个线程进行垃圾回收，会暂停所有的用户线程，不适合服务器环境；</p>
</li>
<li><p><strong>Paralle 并行回收</strong></p>
<p>多个垃圾收集线程并行工作，此时用户线程是暂停的，适用于科学计算/大数据处理后台台处理等<strong>弱交互</strong>场景；垃圾收集速度比Serial快；</p>
</li>
<li><p><strong>CMS 并发标记清除</strong></p>
<p>用户线程和垃圾收集线程同时执行（不一定是并行，可能交替执行），不需要停顿用户线程，互联网公司多用它，适用对响应时间有要求的场景（强交互）；支持几十G内存</p>
</li>
<li><p><strong>G1 Garbage First</strong></p>
<p>将堆内存分割成不同的区域然后并发的对其进行垃圾回收。支撑上百G内存</p>
</li>
<li><p>ZGC</p>
</li>
</ol>
<p><em>注：STW(Stop The World) VS Concurrent(并发)</em></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Java的垃圾收集器共有<strong>七种</strong>：</p>
<p><code>UseSerialGC</code> <code>UseParallelGC</code> <code>UseConcMarkSweepGC</code> <code>UseParNewGC</code> <code>UseParallelOldGC</code> <code>UseG1GC</code></p>
<p><del>（有一种SerialOld已淘汰）</del></p>
<p><strong>各收集器所对应的收集区域：</strong></p>
<p><img src="http://picture.tjtulong.top/%E4%B8%83%E7%A7%8D%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8.png" alt></p>
<p><strong>七种垃圾收集器之间的对应关系：</strong></p>
<p><img src="http://picture.tjtulong.top/%E4%B8%83%E7%A7%8D%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A82.png" alt></p>
<p><strong>部分参数说明：</strong></p>
<ol>
<li>DefNew：Default New Generation</li>
<li>Tenured：Old</li>
<li>ParNew：Parallel New Generation</li>
<li>PSYoungGen：Parallel Scavenge</li>
<li>ParOldGen：Parallel Old Generation</li>
</ol>
<h2 id="Serial"><a href="#Serial" class="headerlink" title="Serial"></a>Serial</h2><p>一个单线程的收集器，在进行垃圾收集的时候，必须<strong>暂停其它所有的工作线程</strong>知道它收集结束。</p>
<p><img src="http://picture.tjtulong.top/%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6.JPG" alt="enter description here"></p>
<p>串行收集器是最古老，最稳定以及效率最高的收集器，只使用一个线程去垃圾回收。但其在进行垃圾收集过程中可能会产生较长的停顿（<strong>Stop-The-World</strong>状态）。虽然在收集垃圾过程中需要暂停所有其他的工作线程，但是它简单高效，<strong>对于限定单个CPU环境来说，没有线程交互的开销可以获得最高的单线程垃圾收集效率，因此Serial垃圾收集器依然是java虚拟机运行在Client模式下默认的新生代垃圾收集器。</strong></p>
<p>对应的JVM参数是：<strong><code>-XX:+UseSerialGC</code></strong></p>
<p>开启后会使用：<strong>Serial(Young区)+Serial Old(Old区)的收集器组合，日志为DefNew +Tenured</strong>。表示：新生代、老年代都会使用串行回收收集器，新生代使用复制算法，老年代使用标记整理算法。</p>
<h2 id="ParNew"><a href="#ParNew" class="headerlink" title="ParNew"></a>ParNew</h2><p>使用多线程进行垃圾回收，在垃圾收集时，会<strong>Stop-the-world暂停</strong>其他所有的工作线程直到它收集结束。</p>
<p><img src="http://picture.tjtulong.top/PerNew.jpeg" width="420" height="高度" alt="图片名称" align="center"></p>
<p>ParNew收集器其实就是Serial收集器新生代的并行多线程版本，最常见的应用场景时<strong>配合老年代的CMS  GC工作</strong>，其余的行为和Serial收集器完全一样，ParNew垃圾收集器在垃圾收集过程成中同样也要暂停所有其他的工作线程，他是很多Java虚拟机运行在Server模式下<strong>新生代</strong>的默认垃圾收集器。</p>
<p>对应的JVM参数：<strong><code>-XX:+UseParNewGC</code></strong>  启用ParNew收集器，只影响新生代的收集，不影响老年代。</p>
<p>开启后会使用：<strong>ParNew(Young区)+Serial Old(Old 区)的收集器组合，日志为ParNew+Tenured，现在已不建议使用</strong>，新生代使用复制算法，老年代采用标记-整理算法。</p>
<p><em>注：<code>-XX:ParallelGCThreads</code>  限制线程数量，默认开启和CPU数目相同的线程数</em></p>
<h2 id="Parallel-Scavenge"><a href="#Parallel-Scavenge" class="headerlink" title="Parallel Scavenge"></a>Parallel Scavenge</h2><p>类似ParNew也是一个新生代垃圾收集器，使用复制算法，也是一个并行的多线程的垃圾收集器，俗称<strong>吞吐量优先</strong>收集器。串行收集器在新生代和老年代的并行化。</p>
<p>它重点关注的是：</p>
<ul>
<li><strong>可控制的吞吐量</strong>（Thoughput = 运行用户代码时间 / (运行用户代码时间 + 垃圾收集时间)，比如程序运行100分钟，垃圾收集时间1分钟，吞吐量就是99%）。高吞吐量意味着高效利用CPU时间，它<strong>多用于在后台运算而不需要太多交互的任务</strong>。</li>
<li><strong>自适应调节策略</strong>也是ParallelScavenge收集器与ParNew收集器的一个重要区别。（虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些参数以提供最合适的停顿时间(-XX:MaxGCPauseMillis)或最大的吞吐量）。</li>
</ul>
<p><code>-XX:MaxGCPauseMillis</code> 垃圾收集器最大停顿的时间，但最大停顿时间过短必然会导致新生代的内存大小变小，垃圾回收频率变高，效率可能降低。<br><code>-XX:CGTIMERatio</code> 吞吐量大小（0-100），默认为99。</p>
<p><strong><code>-XX:+UseParallelGC</code></strong>    <strong><code>-XX:+UseParallelOldGC</code></strong>效果相同，都是<strong>Parallel Scavenge + Parallel Old</strong>的组合</p>
<h2 id="Parallel-Old"><a href="#Parallel-Old" class="headerlink" title="Parallel Old"></a>Parallel Old</h2><p>Parallel Scavenge的老年代版本，使用多线程的<strong>标记-整理</strong>算法，Parallel Old收集器在JDK1.6开始提供</p>
<p>1.6之前，新生代使用的Parallel Scavenge收集器只能搭配年老代的Serial Old收集器，只能保证新生代的吞吐量优先，无法保证整体的吞吐量。</p>
<p>Parallel Old正是为了在老年代同样提供吞吐量优先而产生的垃圾收集器，如果系统对吞吐量要求比较高，JDK1.8后可以考虑新生代Parallel Scavenge和年老代Parallel Old收集器的搭配策略。</p>
<h2 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h2><p>CMS收集器（Concurrent Mark Sweep：并发标记清除）是一种以<strong>获取最短回收停顿时间为目标</strong>的收集器。</p>
<p>适合在互联网站或者B/S系统的服务器上，这类应用尤其重视服务器的响应速度，希望系统停顿时间最短（也有两个短时间的Stop The World）。CMS非常适合堆内存大、CPU核数多的服务区端应用，也是G1出现之大型应用的首选收集器。</p>
<p><img src="http://picture.tjtulong.top/CMS%E6%94%B6%E9%9B%86%E5%99%A8.jpg" alt="enter description here"></p>
<p><strong>4步过程：</strong></p>
<ul>
<li><p><strong>初始标记</strong>（CMS initial mark）</p>
<p>只是标记一下GC Roots能够直接关联的对象，速度很快，仍然需要暂停所有的工作线程。</p>
</li>
<li><p><strong>并发标记</strong>（CMS concurrent mark）</p>
<p>进行GC Roots跟踪过程，和用户线程一起工作，不需要暂停工作线程。主要标记过程，标记全部对象。</p>
</li>
<li><p><strong>重新标记</strong>（CMS remark）</p>
<p>为了修正并发标记期间，因用户程序继续运行而导致标记产生变动的那一部分对象的标记记录，仍然需要暂停所有的工作线程。</p>
</li>
<li><p><strong>并发清除</strong>（CMS concurrent sweep）</p>
<p>清除GC Roots不可达对象，和用户线程一起工作，不需要暂停工作线程，基于标记结果，直接清理对象。</p>
<p>由于耗时最长的并发标记和并发清除过程中，垃圾收集线程可以和用户现在一起并发工作，所以<strong>总体上看来CMS收集器的内存回收和用户线程是一起并发的执行</strong>。</p>
<p>重新标记的过程为什么比并发标记的时间短：</p>
<ul>
<li>对象数的区别：“并发标记”过程需要扫描所有对象，标记出不可达的对象（该清除）和可达的对象（不该清除）；“重新标记”只需要扫描在“并发标记”过程中被标记为可达或新创建的对象，检查其是否在“并发标记”过程中被标记为可达之后，由于用户使用变的不可达了；</li>
<li>并发环境的区别：“并发标记”是与用户线程一起工作的，并发瓶颈较窄（工作线程少+安全检查）；“重新标记”需要stop the world，之后仅有“重新标记”的线程在工作，并发瓶颈宽的多。</li>
</ul>
</li>
</ul>
<p>JVM参数：<strong><code>-XX:+UseConcMarkSweepGC</code></strong>，开启该参数后会自动将<code>-XX:UseParNewGC</code>打开。</p>
<p>开启该参数后，使用<strong>ParNew+CMS+Serial Old</strong>的收集器组合，Serial Old将作为CMS出错的<strong>后备</strong>收集器。</p>
<p><strong>优缺点：</strong></p>
<ul>
<li><p><strong>并发收集停顿低</strong></p>
</li>
<li><p><strong>并发执行，cpu资源压力大</strong></p>
<p>由于并发进行，CMS在收集时与应用线程会同时增加对堆内存的占用，也就是说，<strong>CMS必须要在老年代堆内存用尽之前完成垃圾回收</strong>，否则CMS回收失败时，将出发担保机制，<strong>串行老年代收集器</strong>将会以STW的方式进行一次GC，从而造成较大停顿时间。</p>
</li>
<li><p><strong>采用的标记清除算法会导致大量的碎片</strong></p>
<p>标记清除算法无法整理空间碎片，老年代空间会随着应用时长被逐步耗尽，最后将不得不通过担保机制对堆内存进行压缩。CMS也提供了参数<code>-XX:CMSFullGCsBeForeCompaction</code>(默认0，即每次都进行内存整理)来制定多少次CMS收集之后，进行一次压缩的FullGC。</p>
</li>
</ul>
<p>参考：</p>
<ul>
<li><p><a href="https://www.jianshu.com/p/2a1b2f17d3e4" target="_blank" rel="noopener">图解CMS垃圾回收机制</a> </p>
</li>
<li><p><a href="https://www.jianshu.com/p/86e358afdf17" target="_blank" rel="noopener">CMS垃圾收集器</a></p>
</li>
</ul>
<h2 id="Serial-Old"><a href="#Serial-Old" class="headerlink" title="Serial Old"></a>Serial Old</h2><p>Serial Old是Serial垃圾收集器老年代版本，它同样是个单线程的收集器，使用标记整理算法，这个收集器主要运行在Client的JVM。</p>
<h2 id="G1收集器"><a href="#G1收集器" class="headerlink" title="G1收集器"></a>G1收集器</h2><p>G1(Garbage First)垃圾收集器是当今垃圾回收技术最前沿的成果之一，早在JDK7就已加入JVM的收集器大家庭中，成为HotSpot重点发展的垃圾回收技术。用于服务端。逻辑分代、物理不分代。</p>
<p>主要应用在多CPU和大内存服务器环境下，极大的减少了垃圾收集的停顿时间，全面提升服务器的性能，逐步替代Java8以前的CMS收集器。主要改变是Eden，Survivor和Tenured等内存区域不再是连续的，而是变成了一个一个的<strong>Region</strong>，这种化整为零的方法可以将每次扫描的空间变小，提高效率。</p>
<p><img src="http://picture.tjtulong.top/G1%E5%88%86%E5%9D%97.jpg" alt></p>
<p>优势：并行（多核CPU）与并发；<br>　　　分代收集(新生代和老年代区分不明显)；<br>　　　空间整合；<br>　　　限制收集范围，可预测的停顿。<br>步骤：初始标记、并发标记、最终标记和筛选回收。<br><img src="http://picture.tjtulong.top/G1%E6%94%B6%E9%9B%86%E5%99%A8.jpg" alt="enter description here"></p>
<h2 id="选择垃圾收集器"><a href="#选择垃圾收集器" class="headerlink" title="选择垃圾收集器"></a>选择垃圾收集器</h2><p><img src="http://picture.tjtulong.top/%E9%80%89%E6%8B%A9%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8.jpg" alt></p>
<ul>
<li>单CPU或小内存：SerialNew + SerialOld</li>
<li>多CPU，需要大吞吐量，如后台计算型应用：ParallelNew+ParallelOld</li>
<li>多CPU，追求低停顿时间，需快速响应，如互联网应用：CMS+ParNew</li>
</ul>
<h1 id="GC日志信息"><a href="#GC日志信息" class="headerlink" title="GC日志信息"></a>GC日志信息</h1><p>运行一个会导致OOM的程序：<code>-Xms10m -Xmx10m -XX:+PrintGCDetails</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JVMDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String str = <span class="string">"tjtulong"</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            str += str + <span class="keyword">new</span> Random().nextInt(<span class="number">88888888</span>)</span><br><span class="line">                    + <span class="keyword">new</span> Random().nextInt(<span class="number">99999999</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [PSYoungGen: 2045K-&gt;504K(2560K)] 2045K-&gt;822K(9728K), 0.0019536 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 2443K-&gt;504K(2560K)] 2761K-&gt;1222K(9728K), 0.0013311 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 2484K-&gt;504K(2560K)] 3202K-&gt;2189K(9728K), 0.0010760 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 2094K-&gt;504K(2560K)] 5315K-&gt;4109K(9728K), 0.0009304 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 2089K-&gt;504K(2560K)] 7230K-&gt;6437K(9728K), 0.0015372 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 504K-&gt;504K(1536K)] 6437K-&gt;6437K(8704K), 0.0004704 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC (Allocation Failure) [PSYoungGen: 504K-&gt;0K(1536K)] [ParOldGen: 5933K-&gt;3116K(7168K)] 6437K-&gt;3116K(8704K), [Metaspace: 3516K-&gt;3516K(1056768K)], 0.0059659 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 47K-&gt;32K(2048K)] 6235K-&gt;6219K(9216K), 0.0005355 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC (Ergonomics) [PSYoungGen: 32K-&gt;0K(2048K)] [ParOldGen: 6187K-&gt;4650K(7168K)] 6219K-&gt;4650K(9216K), [Metaspace: 3524K-&gt;3524K(1056768K)], 0.0066428 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 23K-&gt;64K(2048K)] 6209K-&gt;6250K(9216K), 0.0004144 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC (Ergonomics) [PSYoungGen: 64K-&gt;0K(2048K)] [ParOldGen: 6186K-&gt;2347K(7168K)] 6250K-&gt;2347K(9216K), [Metaspace: 3529K-&gt;3529K(1056768K)], 0.0065336 secs] [Times: user=0.05 sys=0.00, real=0.01 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 47K-&gt;80K(2048K)] 7002K-&gt;7034K(9216K), 0.0006274 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC (Ergonomics) [PSYoungGen: 80K-&gt;0K(2048K)] [ParOldGen: 6954K-&gt;5442K(7168K)] 7034K-&gt;5442K(9216K), [Metaspace: 3530K-&gt;3530K(1056768K)], 0.0027675 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 0K-&gt;0K(2048K)] 5442K-&gt;5442K(9216K), 0.0002907 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC (Allocation Failure) Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">[PSYoungGen: 0K-&gt;0K(2048K)] [ParOldGen: 5442K-&gt;5421K(7168K)] 5442K-&gt;5421K(9216K), [Metaspace: 3530K-&gt;3530K(1056768K)], 0.0078808 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] </span><br><span class="line">	at java.util.Arrays.copyOf(Arrays.java:3332)</span><br><span class="line">	at java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)</span><br><span class="line">	at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:674)</span><br><span class="line">	at java.lang.StringBuilder.append(StringBuilder.java:208)</span><br><span class="line">	at com.activemq.demo.JVMDemo.main(JVMDemo.java:9)</span><br><span class="line">Heap</span><br><span class="line"> PSYoungGen      total 2048K, used 50K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</span><br><span class="line">  eden space 1024K, 4% used [0x00000000ffd00000,0x00000000ffd0cbd8,0x00000000ffe00000)</span><br><span class="line">  from space 1024K, 0% used [0x00000000fff00000,0x00000000fff00000,0x0000000100000000)</span><br><span class="line">  to   space 1024K, 0% used [0x00000000ffe00000,0x00000000ffe00000,0x00000000fff00000)</span><br><span class="line"> ParOldGen       total 7168K, used 5421K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</span><br><span class="line">  object space 7168K, 75% used [0x00000000ff600000,0x00000000ffb4b7c0,0x00000000ffd00000)</span><br><span class="line"> Metaspace       used 3562K, capacity 4502K, committed 4864K, reserved 1056768K</span><br><span class="line">  class space    used 391K, capacity 394K, committed 512K, reserved 1048576K</span><br><span class="line"></span><br><span class="line">Process finished with exit code 1</span><br></pre></td></tr></table></figure>
<h2 id="YoungGC日志"><a href="#YoungGC日志" class="headerlink" title="YoungGC日志"></a>YoungGC日志</h2><p><img src="http://picture.tjtulong.top/youngGCDetail.png" alt></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 表示发生了Young GC</span><br><span class="line">[GC (Allocation Failure) </span><br><span class="line">// 新生代内存变化，新生代占总内存<span class="number">1</span>/<span class="number">3</span> </span><br><span class="line">[PSYoungGen: <span class="number">2045</span>K-&gt;<span class="number">504</span>K(<span class="number">2560</span>K)] <span class="number">2045</span>K-&gt;<span class="number">822</span>K(<span class="number">9728</span>K), <span class="number">0</span>.<span class="number">0019536</span> secs] </span><br><span class="line">// 耗时</span><br><span class="line">[Times: user=<span class="number">0</span>.<span class="number">00</span> sys=<span class="number">0</span>.<span class="number">00</span>, real=<span class="number">0</span>.<span class="number">00</span> secs]</span><br></pre></td></tr></table></figure>
<h2 id="Full-GC日志"><a href="#Full-GC日志" class="headerlink" title="Full GC日志"></a>Full GC日志</h2><p><img src="http://picture.tjtulong.top/FullGC%E6%97%A5%E7%A7%9F.jpg" alt></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Full GC标志</span><br><span class="line">[Full GC (Ergonomics) </span><br><span class="line">// 新生代内存变化</span><br><span class="line">[PSYoungGen: <span class="number">80</span>K-&gt;<span class="number">0</span>K(<span class="number">2048</span>K)] </span><br><span class="line">// 老年代内存变化</span><br><span class="line">[ParOldGen: <span class="number">6954</span>K-&gt;<span class="number">5442</span>K(<span class="number">7168</span>K)] <span class="number">7034</span>K-&gt;<span class="number">5442</span>K(<span class="number">9216</span>K), </span><br><span class="line">// 元空间内存变化</span><br><span class="line">[Metaspace: <span class="number">3530</span>K-&gt;<span class="number">3530</span>K(<span class="number">1056768</span>K)], <span class="number">0</span>.<span class="number">0027675</span> secs] </span><br><span class="line">[Times: user=<span class="number">0</span>.<span class="number">00</span> sys=<span class="number">0</span>.<span class="number">00</span>, real=<span class="number">0</span>.<span class="number">00</span> secs]</span><br></pre></td></tr></table></figure>
<h1 id="OOM异常"><a href="#OOM异常" class="headerlink" title="OOM异常"></a>OOM异常</h1><p><strong>都是Error错误</strong></p>
<h2 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h2><p><code>java.lang.StackOverflowError</code></p>
<p>栈空间溢出 ，递归调用时可能出现</p>
<h2 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h2><p><code>java.lang.OutOfMemoryError:Java heap space</code></p>
<p>堆内存溢出，对象过多过大</p>
<h2 id="GC回收时间过长"><a href="#GC回收时间过长" class="headerlink" title="GC回收时间过长"></a>GC回收时间过长</h2><p><code>java.lang.OutOfMemoryError:GC overhead limit exceeded</code></p>
<p>过长的定义是超过<strong>98%</strong>的时间用来做GC并且回收了而不倒<strong>2%</strong>的堆内存，连续多次GC，都回收了不到2%的极端情况下才会抛出。如果不抛出，那就是GC清理的一点内存很快会被再次填满，迫使GC再次执行，这样就恶性循环，CPU使用率一直是100%，而GC却没有任何成果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JVMDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                list.add(String.valueOf(++i).intern());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"***i = "</span> + i);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="直接内存溢出"><a href="#直接内存溢出" class="headerlink" title="直接内存溢出"></a>直接内存溢出</h2><p><code>java.lang.OutOfMemoryError:Direct buffer memory</code></p>
<p>写<strong>NIO程序</strong>经常使用ByteBuffer来读取或写入数据，这是一种基于通道（Channel）与缓存区（Buffer)的I/O方式，它可以<strong>使用Native函数库直接分配堆外内存</strong>，然后通过一个存储在Java堆里面的DirectByteBuffer对象作为这块内存的引用进行操作，这样能在一些场景中显著提高性能，因次避免了在Java堆和native堆中来回复制数据。</p>
<p><code>ByteBuffer.allocate(capability)</code>第一种方式是分配JVM堆内存，属于GC管辖，由于需要拷贝所以速度较慢</p>
<p><code>ByteBuffer.alloctedDirect(capability)</code>分配OS本地内存，不属于GC管辖，不需要拷贝，速度较快</p>
<p>但如果不断分配本地内存，堆内存很少使用，那么JVM就不需要执行GC，DirectByteBuffer对象们就不会被回收，这时候堆内存充足，但本地内存可能已经使用光了，再次尝试分配本地内存就会出现oom，程序崩溃。</p>
<p>可以设置直接内存大小：<code>-XX:MaxDirectMemorySize=50m</code></p>
<h2 id="线程问题"><a href="#线程问题" class="headerlink" title="线程问题"></a>线程问题</h2><p><code>java.lang.OutOfMemoryError:unable to create new native thread</code></p>
<p><strong>产生的原因：</strong></p>
<ul>
<li>应用创建了太多线程，一个应用进程创建了多个线程，超过系统承载极限</li>
<li>服务器并不允许你的应用程序创建这么多线程，linux系统默认允许单个进程可以创建的线程数是<strong>1024</strong>，超过这个数量，就会报错。</li>
</ul>
<p><strong>解决办法：</strong></p>
<ul>
<li><p>降低应用程序创建线程的数量，分析应用是否需要创建这么多线程，如果不是，将线程数减到最低；</p>
</li>
<li><p>如果确实需要创建较多的线程，可以修改linux服务器配置。</p>
</li>
</ul>
<h2 id="元空间溢出"><a href="#元空间溢出" class="headerlink" title="元空间溢出"></a>元空间溢出</h2><p><code>java.lang.OutOfMemoryError:Metaspace</code></p>
<p>元空间主要存放了虚拟机加载的类的信息、常量池、静态变量、即时编译后的代码</p>
<p>向元空间中不断的生产类就可能溢出，例如使用cglib不断生产静态类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OOMTest</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">       <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">           i++;</span><br><span class="line">           Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">           enhancer.setSuperclass(OOMTest.class);</span><br><span class="line">           enhancer.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">           enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor()&#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o,Method method,Object[] objects,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      MethodProxy methodProxy)</span><span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">                   <span class="keyword">return</span> methodProxy.invokeSuper(o,args);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">           enhancer.create();</span><br><span class="line">       &#125; </span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        System.out.println(i+<span class="string">"次后发生了异常"</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JVM/" rel="tag"># JVM</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/20/ActiveMQ高级原理/" rel="next" title="ActiveMQ高级原理">
                <i class="fa fa-chevron-left"></i> ActiveMQ高级原理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/26/G1垃圾收集器/" rel="prev" title="G1垃圾收集器">
                G1垃圾收集器 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://picture.tjtulong.top/QQ%E5%9B%BE%E7%89%8720190515225418.jpg" alt="Tulong Xiao">
            
              <p class="site-author-name" itemprop="name">Tulong Xiao</p>
              <p class="site-description motion-element" itemprop="description">Almost Famous</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">54</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/TJtulong" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:TJtulong@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/2610493505/home" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/TJtulong" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-book"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.tongji.edu.cn/" title="同济大学" target="_blank">同济大学</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#JVM参数调整"><span class="nav-number">1.</span> <span class="nav-text">JVM参数调整</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#标配参数"><span class="nav-number">1.1.</span> <span class="nav-text">标配参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#X参数"><span class="nav-number">1.2.</span> <span class="nav-text">X参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XX参数"><span class="nav-number">1.3.</span> <span class="nav-text">XX参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Boolean类型"><span class="nav-number">1.3.1.</span> <span class="nav-text">Boolean类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KV设值类型"><span class="nav-number">1.3.2.</span> <span class="nav-text">KV设值类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看参数"><span class="nav-number">1.4.</span> <span class="nav-text">查看参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用基本配置参数"><span class="nav-number">1.5.</span> <span class="nav-text">常用基本配置参数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#垃圾收集器"><span class="nav-number">2.</span> <span class="nav-text">垃圾收集器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#垃圾回收方式"><span class="nav-number">2.1.</span> <span class="nav-text">垃圾回收方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">2.2.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Serial"><span class="nav-number">2.3.</span> <span class="nav-text">Serial</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ParNew"><span class="nav-number">2.4.</span> <span class="nav-text">ParNew</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Parallel-Scavenge"><span class="nav-number">2.5.</span> <span class="nav-text">Parallel Scavenge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Parallel-Old"><span class="nav-number">2.6.</span> <span class="nav-text">Parallel Old</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMS"><span class="nav-number">2.7.</span> <span class="nav-text">CMS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Serial-Old"><span class="nav-number">2.8.</span> <span class="nav-text">Serial Old</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#G1收集器"><span class="nav-number">2.9.</span> <span class="nav-text">G1收集器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#选择垃圾收集器"><span class="nav-number">2.10.</span> <span class="nav-text">选择垃圾收集器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GC日志信息"><span class="nav-number">3.</span> <span class="nav-text">GC日志信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#YoungGC日志"><span class="nav-number">3.1.</span> <span class="nav-text">YoungGC日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Full-GC日志"><span class="nav-number">3.2.</span> <span class="nav-text">Full GC日志</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#OOM异常"><span class="nav-number">4.</span> <span class="nav-text">OOM异常</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#栈溢出"><span class="nav-number">4.1.</span> <span class="nav-text">栈溢出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#堆溢出"><span class="nav-number">4.2.</span> <span class="nav-text">堆溢出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC回收时间过长"><span class="nav-number">4.3.</span> <span class="nav-text">GC回收时间过长</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#直接内存溢出"><span class="nav-number">4.4.</span> <span class="nav-text">直接内存溢出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#线程问题"><span class="nav-number">4.5.</span> <span class="nav-text">线程问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#元空间溢出"><span class="nav-number">4.6.</span> <span class="nav-text">元空间溢出</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tulong Xiao</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
